/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model combined with role-based access for administrative and doctor tasks.
 * All sensitive user data is isolated within a user-specific document tree, accessible only to the authenticated owner.
 *
 * Data Structure: The data is organized hierarchically for most user data. Core user data and its related subcollections (exerciseLogs, reminders, llm_calls)
 * are stored under `/users/{userId}`. Consultations are in a top-level collection to allow for queries across patients by doctors.
 *
 * Key Security Decisions:
 * - User Isolation: Users can only read or write data within their own `/users/{userId}` document tree.
 * - Role-Based Access Control (RBAC): The existence of a document in `/roles_admin/{userId}` or `/roles_doctor/{userId}` grants specific privileges.
 * - Consultation Access: A user can access their own consultations. A doctor can access any consultation where their UID matches the `doctorId`.
 *
 * Denormalization for Authorization: The rules rely on path-based ownership (`/users/{userId}/...`) and checks on `resource.data` fields to grant access, which is highly performant.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingDoc() {
      return resource != null;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
     
    function isDoctor() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_doctor/$(request.auth.uid));
    }

    function isAssociatedDoctor(consultation) {
        return isDoctor() && request.auth.uid == consultation.doctorId;
    }

    function hasValidNewUserData(userId) {
      return request.resource.data.id == userId;
    }

    function isUserIdImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    function hasValidSubcollectionData(userId) {
      return request.resource.data.userId == userId;
    }

    function isSubcollectionUserIdImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }

    // User Profile
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && hasValidNewUserData(userId);
      allow update: if isExistingOwner(userId) && isUserIdImmutable();
      allow delete: if isAdmin();
    }

    // Eye Exercises Catalog
    match /eye_exercises/{exerciseId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    // User-specific subcollections
    match /users/{userId}/{collection}/{docId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && hasValidSubcollectionData(userId);
      allow update: if isExistingOwner(userId) && isSubcollectionUserIdImmutable();
      allow delete: if isExistingOwner(userId);
    }
    
    // Consultations
    match /consultations/{consultationId} {
      allow get: if isOwner(resource.data.userId) || isAssociatedDoctor(resource.data);
      allow list: if isDoctor(); // Doctors can list all consultations to find theirs
      allow create: if isOwner(request.resource.data.userId); // Only patients can create for themselves
      allow update: if isOwner(resource.data.userId) || isAssociatedDoctor(resource.data);
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // Medications Catalog
    match /medications/{medicationId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    // Role Management
    match /roles_admin/{userId} {
      allow read, write: if isAdmin();
    }

    match /roles_doctor/{userId} {
      allow read, write: if isAdmin(); // Only admins can make someone a doctor
    }
  }
}

    